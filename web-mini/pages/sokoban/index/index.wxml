<wxs module="utils">
var isTarget = function(targets, row, col) {
  for (var i = 0; i < targets.length; i++) {
    if (targets[i].row === row && targets[i].col === col) {
      return true;
    }
  }
  return false;
}

var isBox = function(boxes, row, col) {
  for (var i = 0; i < boxes.length; i++) {
    if (boxes[i].row === row && boxes[i].col === col) {
      return true;
    }
  }
  return false;
}

module.exports = {
  isTarget: isTarget,
  isBox: isBox
};
</wxs>

<view class="container" style="padding-top: {{CustomBar}}px;">
  <view class="game-header">
    <view class="title">推箱子<text bindtap="showModal" data-target="gameRuleModal" class="text-light light cuIcon-question padding-left-sm"></text></view>
    <view class="stats">
      <view class="stat-item" bind:tap="goto">
        <text class="score-label">主页</text>
        <text class="cuIcon-home score-value"></text>
      </view>
      <view class="stat-item">
        <text class="stat-label">关卡</text>
        <text class="stat-value">{{level}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">步数</text>
        <text class="stat-value">{{moves}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">最佳</text>
        <text class="stat-value">{{bestMoves || '-'}}</text>
      </view>
    </view>
  </view>

  <view class="game-board">
    <view wx:for="{{board}}" wx:for-index="rowIdx" wx:for-item="row" wx:key="rowIdx" class="board-row">
      <view wx:for="{{row}}" wx:for-index="colIdx" wx:for-item="cell" wx:key="colIdx" class="cell">
        <view wx:if="{{cell === '#'}}" class="wall"></view>
        <view wx:else class="floor">
          <view wx:if="{{utils.isTarget(targets, rowIdx, colIdx)}}" class="target"></view>
          <view wx:if="{{utils.isBox(boxes, rowIdx, colIdx)}}" 
                class="box {{utils.isTarget(targets, rowIdx, colIdx) ? 'on-target' : ''}}">
          </view>
          <view wx:if="{{player.row === rowIdx && player.col === colIdx}}" class="player">👤</view>
        </view>
      </view>
    </view>
  </view>

  <view class="controls">
    <view class="control-row">
      <button class="dir-btn" data-direction="up" bindtap="onDirectionTap">↑</button>
    </view>
    <view class="control-row">
      <button class="dir-btn" data-direction="left" bindtap="onDirectionTap">←</button>
      <button class="dir-btn" data-direction="down" bindtap="onDirectionTap">↓</button>
      <button class="dir-btn" data-direction="right" bindtap="onDirectionTap">→</button>
    </view>
  </view>

  <view class="game-controls">
    <button class="control-btn" bindtap="restart">重新开始</button>
    <button class="control-btn secondary" bindtap="resetBest">重置最佳</button>
  </view>

  <view wx:if="{{gameWon}}" class="game-over">
    <text class="game-over-text">🎉 恭喜完成！</text>
  </view>
</view>
<!-- 游戏规则 -->
<view class="cu-modal {{modalName == 'gameRuleModal'?'show':''}}">
  <view class="cu-dialog">
    <view class="cu-bar bg-white justify-end">
      <view class="content">游戏规则</view>
      <view class="action" bindtap="hideModal">
        <text class="cuIcon-close text-red"></text>
      </view>
    </view>
    <view class="padding bg-white" style="text-align: start;">
      <text class="rules-text">使用方向键控制角色移动。推动箱子到绿色目标位置即可。注意：箱子只能推动不能拉动，如果箱子被推到角落无法移动，需要重新开始。将所有箱子推到目标位置即可通关！</text>
    </view>
  </view>
</view>
